# -*- coding: utf-8 -*-
"""
map_loader_kivy.py（共通ユーティリティ）

目的：
  CSVマップ（例: assets/maps/steel_map01.csv）を読み込み、
  2次元グリッド（タイルIDの表）として返す関数を提供します。

今回の改修の狙い：
  「相対パスが、実行時のカレントディレクトリに依存して壊れる」問題を防ぎます。
  具体的には、"assets/..." のような相対パスを、
  “この map_loader_kivy.py が置いてあるフォルダ（プロジェクト直下想定）” を基準に解決します。
"""

from pathlib import Path  # OS差（Windowsの\とLinuxの/など）を吸収して安全にパスを扱う標準機能です


# -----------------------------------------------------------------------------
# ✅ 基準ディレクトリ（超重要）
# -----------------------------------------------------------------------------
# Path(__file__) : 「この Python ファイル（map_loader_kivy.py）自身の場所」を指します
# resolve()      : 相対要素（..など）を解決して “確定した絶対パス” にします
# parent         : ファイルの1つ上のフォルダ（=このファイルが入っているフォルダ）です
#
# これを基準にすることで、
#   - VSCodeの実行
#   - ダブルクリック実行
#   - 別フォルダから python を叩く
# どの起動方法でも assets/.. を正しく見つけられるようになります。
_BASE_DIR = Path(__file__).resolve().parent


def load_csv_as_tilemap(path: str):
    """
    CSVマップを読み込み、（grid, rows, cols）を返します。

    引数:
      path : str
        例) "assets/maps/steel_map01.csv"
        - 絶対パスでもOK
        - 相対パスでもOK（この場合、_BASE_DIR 基準に変換してから探します）

    戻り値:
      grid : 2次元配列（list[list[int]] 等）  ※ここは既存実装に合わせます
      rows : 行数
      cols : 列数
    """

    # -------------------------------------------------------------------------
    # 1) 文字列パスを Path に変換
    # -------------------------------------------------------------------------
    # Pathにしておくと、
    #   - exists() で存在確認
    #   - open() で安全にファイルを開く
    #   - / 演算子でパス結合（"フォルダ / ファイル"）ができる
    # などが簡単になって、バグが減ります。
    p = Path(path)

    # -------------------------------------------------------------------------
    # 2) 相対パスなら「このファイルの場所」を基準に解決する
    # -------------------------------------------------------------------------
    # is_absolute() が False のとき、
    #   "assets/maps/steel_map01.csv" は「実行した場所」次第で意味が変わってしまいます。
    # そこで「map_loader_kivy.py がある場所（=プロジェクト直下想定）」を基準に
    # assets/... を探すように揃えます。
    if not p.is_absolute():
        # 例:
        #   _BASE_DIR = D:/.../RPG_Steel_MasterD
        #   p         = assets/maps/steel_map01.csv
        #   -> p = D:/.../RPG_Steel_MasterD/assets/maps/steel_map01.csv
        p = (_BASE_DIR / p).resolve()

    # -------------------------------------------------------------------------
    # 3) 見つからなかった場合は「解決後のフルパス」を出して即わかるようにする
    # -------------------------------------------------------------------------
    # ここで “どこを探しにいって失敗したか” が一撃で分かります。
    # 生徒さん対応でも、原因切り分けが圧倒的に速くなります。
    if not p.exists():
        raise FileNotFoundError(
            f"[map_loader_kivy] Map CSV not found.\n"
            f"  requested: {path}\n"
            f"  resolved : {p}\n"
            f"  hint     : assets/maps 配下にファイル名が一致するCSVがあるか確認してください。"
        )

    # -------------------------------------------------------------------------
    # 4) UTF-8でCSVを開く（Windowsでも文字化けしにくい）
    # -------------------------------------------------------------------------
    # encoding="utf-8" を固定しておくと、環境差での事故が減ります。
    # newline="" はCSV読み取りで改行の扱いを安定させるために入れることがありますが、
    # 既存実装に影響を出したくない場合は省略でもOKです。
    with p.open("r", encoding="utf-8") as f:
        # ---------------------------------------------------------------------
        # ここから下は「元の map_loader_kivy.py の処理」をそのまま残してください
        # （例：f を読み込んで grid/rows/cols を作る処理）
        # ---------------------------------------------------------------------

        # ▼（例）ここはあなたの既存実装に合わせてください：
        # text = f.read()
        # ...
        # return grid, rows, cols

        # もしこの行があると実行エラーになるので、必ず既存処理に置き換えてください。
        raise NotImplementedError("ここから下は既存のCSV解析処理を残してください")
