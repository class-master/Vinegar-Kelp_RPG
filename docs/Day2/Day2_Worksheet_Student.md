# Day2：壁衝突と会話トリガの日（7人×3時間用シナリオ）

## 0. 今日のゴール（先生が最初に読む用）

3時間で、次を「クラス全体」として完成させます。

1. プレイヤーが **壁タイルにめり込まずに移動できる**（軸分離で衝突判定）  
2. NPCの近くで **Eキーを押すと会話（ダミー）メッセージが表示される**  
3. 「どのタイルが壁なのか」「どうやって当たり判定しているか」を説明できる  

### 絶対ルール

- `main_day1.py` は **書き換え禁止**（参考に読むのはOK）
- 触るファイルは基本的に `main_day2.py` と `docs/Day2_buglog.md`
- 迷ったら先生かこのプリントに必ず戻る

---

## 1. 今日の7人の役割（先に割り当てる）

| No | 役割名                     | 触るファイル          | ざっくりやること                                         |
|----|----------------------------|-----------------------|----------------------------------------------------------|
| A  | 壁タイル＆衝突関数担当     | `main_day2.py`        | どのタイルが壁か決めて、`rect_collides` を整える         |
| B  | 軸分離移動担当             | `main_day2.py`        | X→Yの順で移動し、壁と当たったら止まる処理を書く         |
| C  | NPC配置担当                | `main_day2.py`        | NPCの位置と数を決め、見た目を調整する                    |
| D  | 会話トリガ（Eキー）担当    | `main_day2.py`        | NPC近く＋EキーでHUDに会話メッセージを表示する            |
| E  | HUD＆メッセージ文担当      | `main_day2.py`        | 画面上部の説明文と、会話テキストの内容を作る             |
| F  | 難易度＆マップ巡回性担当   | `main_day2.py`        | 行ける／行けない場所のバランスを調整し、詰まらないようにする |
| G  | テスト＆バグログ担当       | `docs/Day2_buglog.md` | テストプレイとバグ／改善アイデアの記録                   |

---

## 2. 今日の時間割（板書用）

- 0:00〜0:10　Day1の復習と、Day2のゴール共有
- 0:10〜0:20　役割分担とマップ／NPCのイメージ共有
- 0:20〜1:10　**個人作業タイム**（A〜Fの担当ごとにコーディング）
- 1:10〜1:40　コードの結合＆簡単なプレイテスト
- 1:40〜2:20　G主導のテストプレイ＆バグログ作成
- 2:20〜3:00　今日のまとめと、Day3への発展案の確認

---

## 3. 各役割の「やることチェックリスト」

### 3-1. A：壁タイル＆衝突関数担当

**目的**：どのタイルが「壁」なのかを決め、矩形衝突関数 `rect_collides` を整える。

#### チェックリスト

- [ ] `solid = {1,2,3,4}` など、壁として扱うタイルIDの集合を確認・調整した
- [ ] プレイヤー矩形（px, py, w, h）とタイル矩形とのAABB判定を理解した
- [ ] `rect_collides` がTrueのとき、「その位置には進めない」ことをチームで共有した

#### サンプルコード（抜粋）

```python
def rect_collides(px, py, w, h, grid, solid={1,2,3,4}):
    ts = TILE_SIZE
    min_c = max(0, int(px)//ts)
    max_c = min(len(grid[0])-1, int((px+w-1))//ts)
    min_r = max(0, int(py)//ts)
    max_r = min(len(grid)-1, int((py+h-1))//ts)
    for r in range(min_r, max_r+1):
        for c in range(min_c, max_c+1):
            if grid[r][c] in solid:
                wx, wy = c*ts, r*ts
                if not (px+w <= wx or wx+ts <= px or py+h <= wy or wy+ts <= py):
                    return True
    return False
```

> ✅ Aさんは「**物理ルール係**」です。  
> どのタイルを壁にするかで、探索できる範囲が大きく変わります。

---

### 3-2. B：軸分離移動担当

**目的**：X方向→Y方向の順番で移動し、壁と当たったらその方向の移動だけ止める。

#### チェックリスト

- [ ] `nx = self.px + self.vx` でX方向の仮の位置を計算している
- [ ] X方向の衝突が無ければ `self.px = nx` を採用するロジックになっている
- [ ] Y方向も同様に `ny` を使って軸分離をしている
- [ ] 片方だけが止まるおかげで、「壁に沿って滑る」感覚になることを確認した

#### サンプルコード（抜粋）

```python
        nx = self.px + self.vx
        if not rect_collides(nx, self.py, self.w, self.h, self.grid):
            self.px = nx

        ny = self.py + self.vy
        if not rect_collides(self.px, ny, self.w, self.h, self.grid):
            self.py = ny
```

> ✅ Bさんは「**移動の安定係**」です。  
> 斜めにぶつかったときの挙動をよく観察してみてください。

---

### 3-3. C：NPC配置担当

**目的**：NPCの位置・数・見た目を決めて、マップが寂しくならないようにする。

#### チェックリスト

- [ ] `self.npcs = [(x, y, w, h), ...]` のリストを読み取った
- [ ] タイルに合う位置（タイルの中心付近）にNPCを配置した
- [ ] プレイヤーが近づきやすい場所にNPCを置いた（端の方に置きすぎない）

#### サンプルコード（抜粋）

```python
        ts=TILE_SIZE
        self.npcs = [
            (ts*10, ts*6, ts-6, ts-6),
            (ts*14, ts*8, ts-6, ts-6),
        ]
```

> ✅ Cさんは「**マップのにぎやかし担当**」です。  
> プレイヤーが「話しかけに行きたくなる」位置を考えてみてください。

---

### 3-4. D：会話トリガ（Eキー）担当

**目的**：NPCの近くでEキーを押したときに、HUDに会話メッセージを表示する。

#### チェックリスト

- [ ] Eキーのkeycode（`ekey=101`）を確認した
- [ ] NPCとの距離判定（AABB）を理解した
- [ ] 一番近いNPCに話しかけているようなイメージで、メッセージを表示した
- [ ] NPCから離れたらメッセージが消える or 初期メッセージに戻るようにした（必要なら）

#### サンプルコード（抜粋）

```python
        if ekey in self.keys:
            for (nxp, nyp, nw, nh) in self.npcs:
                if not (self.px+self.w <= nxp or nxp+nw <= self.px or
                        self.py+self.h <= nyp or nyp+nh <= self.py):
                    self.hud.text = "NPC：こんにちは！（会話ダミー）"
                    break
```

> ✅ Dさんは「**会話イベント係**」です。  
> 実際の会話システム（選択肢など）への発展もイメージしながら作ってみましょう。

---

### 3-5. E：HUD＆メッセージ文担当

**目的**：HUD（画面上部）に表示するテキストを整え、プレイヤーに状況を分かりやすく伝える。

#### チェックリスト

- [ ] 通常時のHUDメッセージ（操作説明）を分かりやすくした
- [ ] 会話中のメッセージ文を、もう少し「それっぽい」文章にした
- [ ] 将来の拡張（FOV・アイテム拾い）に向けて、ヒントとなるメッセージ案も考えた

> ✅ Eさんは「**言葉のデザイナー**」です。  
> 短い文章で、「何が起きているのか」「何をすればいいのか」が分かるように工夫してみてください。

---

### 3-6. F：難易度＆マップ巡回性担当

**目的**：壁とNPCの配置を見て、「行き止まりが多すぎないか」「移動が窮屈すぎないか」を調整する。

#### チェックリスト

- [ ] 行ける場所／行けない場所を実際に歩いて確認した
- [ ] 「完全に閉じ込められて抜け出せない」場所がないかをチェックした
- [ ] NPCに話しかけに行く導線が、あまりストレスにならないように調整した

> ✅ Fさんは「**マップ全体のゲーム体験係**」です。  
> まだFOVやアイテムは入っていませんが、「ここに置いたら面白そう」という場所をメモしておきましょう。

---

### 3-7. G：テスト＆バグログ担当

**目的**：Day2 のゲームをいろいろなパターンで遊び、バグと改善点を文章に残す。

- 触るファイル：`docs/Day2_buglog.md`（新規作成）

#### チェックリスト

- [ ] 少なくとも5回以上プレイした
- [ ] 「引っかかる場所」「話しかけづらいNPC」などの感想を書いた
- [ ] バグや改善案を1件ずつタイトル付きで記録した

#### バグログテンプレ

```text
【2025-xx-xx Day2 バグログ】

■バグ1：壁の角にひっかかって動けなくなる
内容：
    斜め方向から角にぶつかると、その場で動けなくなる。
原因（予想）：
    rect_collidesのsolid指定か、軸分離処理の条件に問題がある。
対応：
    solidタイルのIDや矩形の範囲を見直す。

■改善アイデア1：会話の種類を増やしたい
内容：
    同じNPCでも、話しかけるたびに違うセリフが出ると楽しそう。
メモ：
    ランダムでメッセージを選ぶリストを用意する、など。
```

---

## 4. 全員共通のNGリスト

- `main_day1.py` にDay2のコードを混ぜない（ファイルを分けておく）
- 壁の設定を変えたときに、**必ずマップ全体を一度歩いて確認する前に提出しない**
- `print` デバッグを残しっぱなしにして、ログが流れすぎて読めなくならないようにする

---

## 5. 今日のまとめメモ欄（クラス用）

- 今日できたこと：

- 次にやりたいこと（Day3 への発展案など）：
